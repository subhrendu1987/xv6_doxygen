\hypertarget{file_8c_source}{}\doxysection{file.\+c}
\mbox{\hyperlink{file_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00001}00001 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00002}00002 \textcolor{comment}{// File descriptors}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00003}00003 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00004}00004 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00005}00005 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{types_8h}{types.h}}"{}}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00006}00006 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{defs_8h}{defs.h}}"{}}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00007}00007 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{param_8h}{param.h}}"{}}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00008}00008 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{fs_8h}{fs.h}}"{}}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00009}00009 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{spinlock_8h}{spinlock.h}}"{}}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00010}00010 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{sleeplock_8h}{sleeplock.h}}"{}}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00011}00011 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{file_8h}{file.h}}"{}}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00012}00012 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00013}\mbox{\hyperlink{file_8c_aadbb32b41c0d0e9c19d6d8fa3a0a6502}{00013}} \textcolor{keyword}{struct }\mbox{\hyperlink{structdevsw}{devsw}} \mbox{\hyperlink{structdevsw}{devsw}}[\mbox{\hyperlink{param_8h_aa564a41c8409694da49b0badf2bb2853}{NDEV}}];}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00014}00014 \textcolor{keyword}{struct }\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00015}\mbox{\hyperlink{file_8c_ab28e82cd5dda7d960095706a3ea20572}{00015}}   \textcolor{keyword}{struct }\mbox{\hyperlink{structspinlock}{spinlock}} \mbox{\hyperlink{bio_8c_ab28e82cd5dda7d960095706a3ea20572}{lock}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00016}\mbox{\hyperlink{file_8c_a7cfa5243b3d349a415c7500c962fe9a5}{00016}}   \textcolor{keyword}{struct }\mbox{\hyperlink{structfile}{file}} \mbox{\hyperlink{structfile}{file}}[\mbox{\hyperlink{param_8h_a8485f4e81de2537e6a0935626167a775}{NFILE}}];}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00017}\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{00017}} \} \mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00018}00018 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00019}00019 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00020}\mbox{\hyperlink{defs_8h_a66bb5a4b304ea0f851dd999fc8195fa4}{00020}} \mbox{\hyperlink{file_8c_a66bb5a4b304ea0f851dd999fc8195fa4}{fileinit}}(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00021}00021 \{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00022}00022   \mbox{\hyperlink{defs_8h_ab56d728e6966819a0260c358d3ac3419}{initlock}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock, \textcolor{stringliteral}{"{}ftable"{}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00023}00023 \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00024}00024 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00025}00025 \textcolor{comment}{// Allocate a file structure.}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00026}00026 \textcolor{keyword}{struct }\mbox{\hyperlink{structfile}{file}}*}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00027}\mbox{\hyperlink{defs_8h_ac56b15561658d0e74ce1c53309b8f97d}{00027}} \mbox{\hyperlink{file_8c_ac56b15561658d0e74ce1c53309b8f97d}{filealloc}}(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00028}00028 \{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00029}00029   \textcolor{keyword}{struct }\mbox{\hyperlink{structfile}{file}} *f;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00030}00030 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00031}00031   \mbox{\hyperlink{defs_8h_afe4ef8638f1ecb962a6e67fb086ee3b8}{acquire}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00032}00032   \textcolor{keywordflow}{for}(f = \mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.file; f < \mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.file + \mbox{\hyperlink{param_8h_a8485f4e81de2537e6a0935626167a775}{NFILE}}; f++)\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00033}00033     \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a41c818f828adea488058bca63e4df23f}{ref}} == 0)\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00034}00034       f-\/>\mbox{\hyperlink{structfile_a41c818f828adea488058bca63e4df23f}{ref}} = 1;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00035}00035       \mbox{\hyperlink{defs_8h_a4f8616948f3dbce65671f666eed1d669}{release}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00036}00036       \textcolor{keywordflow}{return} f;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00037}00037     \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00038}00038   \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00039}00039   \mbox{\hyperlink{defs_8h_a4f8616948f3dbce65671f666eed1d669}{release}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00040}00040   \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00041}00041 \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00042}00042 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00043}00043 \textcolor{comment}{// Increment ref count for file f.}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00044}00044 \textcolor{keyword}{struct }\mbox{\hyperlink{structfile}{file}}*}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00045}\mbox{\hyperlink{defs_8h_a67aac4011147fe1ec585211e23580721}{00045}} \mbox{\hyperlink{file_8c_a9ef0346d08d8ed79ce2a9c03f9a4b4b2}{filedup}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structfile}{file}} *f)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00046}00046 \{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00047}00047   \mbox{\hyperlink{defs_8h_afe4ef8638f1ecb962a6e67fb086ee3b8}{acquire}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00048}00048   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a41c818f828adea488058bca63e4df23f}{ref}} < 1)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00049}00049     \mbox{\hyperlink{console_8c_a95c0aca5d6d7487933984f08b189917a}{panic}}(\textcolor{stringliteral}{"{}filedup"{}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00050}00050   f-\/>\mbox{\hyperlink{structfile_a41c818f828adea488058bca63e4df23f}{ref}}++;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00051}00051   \mbox{\hyperlink{defs_8h_a4f8616948f3dbce65671f666eed1d669}{release}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00052}00052   \textcolor{keywordflow}{return} f;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00053}00053 \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00054}00054 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00055}00055 \textcolor{comment}{// Close file f.  (Decrement ref count, close when reaches 0.)}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00056}00056 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00057}\mbox{\hyperlink{defs_8h_ac865ee0b2d70f753d61d1fefef9de0f6}{00057}} \mbox{\hyperlink{file_8c_ae557c81ab89c24219146144bb6adaa2c}{fileclose}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structfile}{file}} *f)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00058}00058 \{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00059}00059   \textcolor{keyword}{struct }\mbox{\hyperlink{structfile}{file}} ff;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00060}00060 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00061}00061   \mbox{\hyperlink{defs_8h_afe4ef8638f1ecb962a6e67fb086ee3b8}{acquire}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00062}00062   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a41c818f828adea488058bca63e4df23f}{ref}} < 1)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00063}00063     \mbox{\hyperlink{console_8c_a95c0aca5d6d7487933984f08b189917a}{panic}}(\textcolor{stringliteral}{"{}fileclose"{}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00064}00064   \textcolor{keywordflow}{if}(-\/-\/f-\/>\mbox{\hyperlink{structfile_a41c818f828adea488058bca63e4df23f}{ref}} > 0)\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00065}00065     \mbox{\hyperlink{defs_8h_a4f8616948f3dbce65671f666eed1d669}{release}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00066}00066     \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00067}00067   \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00068}00068   ff = *f;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00069}00069   f-\/>\mbox{\hyperlink{structfile_a41c818f828adea488058bca63e4df23f}{ref}} = 0;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00070}00070   f-\/>\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} = \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5a224e095442d50a6bd1058fd742fb68c7}{FD\_NONE}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00071}00071   \mbox{\hyperlink{defs_8h_a4f8616948f3dbce65671f666eed1d669}{release}}(\&\mbox{\hyperlink{file_8c_aa3cdfe534b83322d79f0605488e11ecc}{ftable}}.lock);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00072}00072 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00073}00073   \textcolor{keywordflow}{if}(ff.\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} == \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5a59fcf59caf6e70c3cc3cc48291b89752}{FD\_PIPE}})}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00074}00074     \mbox{\hyperlink{defs_8h_af6220973e389c74782d76ae641a5e7db}{pipeclose}}(ff.\mbox{\hyperlink{structfile_a19d83a8d6cb47902fe8c762d2798c198}{pipe}}, ff.\mbox{\hyperlink{structfile_a6e1b641ea1551ac4316a0c11a683df45}{writable}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00075}00075   \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(ff.\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} == \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5aa5d8c5e0d95ed88367e96ecebfdf326d}{FD\_INODE}})\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00076}00076     \mbox{\hyperlink{defs_8h_a603ca98212e00d2ffdba7827ef0f1003}{begin\_op}}();}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00077}00077     \mbox{\hyperlink{defs_8h_a29530a0afdfe924818d8c70b6724528d}{iput}}(ff.\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00078}00078     \mbox{\hyperlink{defs_8h_a2504e37a109f9bae5ca11fe89e4e8fa1}{end\_op}}();}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00079}00079   \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00080}00080 \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00081}00081 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00082}00082 \textcolor{comment}{// Get metadata about file f.}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00083}00083 \textcolor{keywordtype}{int}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00084}\mbox{\hyperlink{defs_8h_ac4979f97957194db01001985b1bfa84e}{00084}} \mbox{\hyperlink{file_8c_afff8e849fa54dea2a5a27dbb97474607}{filestat}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structfile}{file}} *f, \textcolor{keyword}{struct} \mbox{\hyperlink{structstat}{stat}} *st)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00085}00085 \{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00086}00086   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} == \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5aa5d8c5e0d95ed88367e96ecebfdf326d}{FD\_INODE}})\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00087}00087     \mbox{\hyperlink{defs_8h_a29a4d743d41fe659f74b0a57fdc25012}{ilock}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00088}00088     \mbox{\hyperlink{defs_8h_a528f45ea5530504abc7113acc2154348}{stati}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}}, st);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00089}00089     \mbox{\hyperlink{defs_8h_af301c10ad8ced77a5dfb2de3a64c666c}{iunlock}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00090}00090     \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00091}00091   \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00092}00092   \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00093}00093 \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00094}00094 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00095}00095 \textcolor{comment}{// Read from file f.}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00096}00096 \textcolor{keywordtype}{int}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00097}\mbox{\hyperlink{defs_8h_a6bd1db179155944c9d1fbc89d8b7b162}{00097}} \mbox{\hyperlink{file_8c_a1dc8c87c7e48bdaaf98e9c7047928f29}{fileread}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structfile}{file}} *f, \textcolor{keywordtype}{char} *addr, \textcolor{keywordtype}{int} n)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00098}00098 \{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00099}00099   \textcolor{keywordtype}{int} \mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00100}00100 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00101}00101   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a0c5c8eced8bc562dbbecc8d450a6b646}{readable}} == 0)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00102}00102     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00103}00103   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} == \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5a59fcf59caf6e70c3cc3cc48291b89752}{FD\_PIPE}})}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00104}00104     \textcolor{keywordflow}{return} \mbox{\hyperlink{defs_8h_acd589a0d0d6d34b446baf33755eef519}{piperead}}(f-\/>\mbox{\hyperlink{structfile_a19d83a8d6cb47902fe8c762d2798c198}{pipe}}, addr, n);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00105}00105   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} == \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5aa5d8c5e0d95ed88367e96ecebfdf326d}{FD\_INODE}})\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00106}00106     \mbox{\hyperlink{defs_8h_a29a4d743d41fe659f74b0a57fdc25012}{ilock}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00107}00107     \textcolor{keywordflow}{if}((\mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}} = \mbox{\hyperlink{defs_8h_a2415273b06f31f0f2587b7325588a7e4}{readi}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}}, addr, f-\/>\mbox{\hyperlink{structfile_a94a911be6cc1b1326728392d8b40150d}{off}}, n)) > 0)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00108}00108       f-\/>\mbox{\hyperlink{structfile_a94a911be6cc1b1326728392d8b40150d}{off}} += \mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00109}00109     \mbox{\hyperlink{defs_8h_af301c10ad8ced77a5dfb2de3a64c666c}{iunlock}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00110}00110     \textcolor{keywordflow}{return} \mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00111}00111   \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00112}00112   \mbox{\hyperlink{console_8c_a95c0aca5d6d7487933984f08b189917a}{panic}}(\textcolor{stringliteral}{"{}fileread"{}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00113}00113 \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00114}00114 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00115}00115 \textcolor{comment}{//PAGEBREAK!}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00116}00116 \textcolor{comment}{// Write to file f.}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00117}00117 \textcolor{keywordtype}{int}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00118}\mbox{\hyperlink{defs_8h_a90e8980df48fa900fc33de53448a2e18}{00118}} \mbox{\hyperlink{file_8c_ab8de757a0a9f58dcc6511ea5e46ebb88}{filewrite}}(\textcolor{keyword}{struct} \mbox{\hyperlink{structfile}{file}} *f, \textcolor{keywordtype}{char} *addr, \textcolor{keywordtype}{int} n)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00119}00119 \{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00120}00120   \textcolor{keywordtype}{int} \mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00121}00121 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00122}00122   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a6e1b641ea1551ac4316a0c11a683df45}{writable}} == 0)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00123}00123     \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00124}00124   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} == \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5a59fcf59caf6e70c3cc3cc48291b89752}{FD\_PIPE}})}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00125}00125     \textcolor{keywordflow}{return} \mbox{\hyperlink{defs_8h_ae63b0db4ca2cbb2025b89d977c6535b1}{pipewrite}}(f-\/>\mbox{\hyperlink{structfile_a19d83a8d6cb47902fe8c762d2798c198}{pipe}}, addr, n);}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00126}00126   \textcolor{keywordflow}{if}(f-\/>\mbox{\hyperlink{structfile_a3a28c808a8dcd4acf45087ac30c075e7}{type}} == \mbox{\hyperlink{structfile_a4aeeba6a286e58966d853aa1f510d3d5aa5d8c5e0d95ed88367e96ecebfdf326d}{FD\_INODE}})\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00127}00127     \textcolor{comment}{// write a few blocks at a time to avoid exceeding}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00128}00128     \textcolor{comment}{// the maximum log transaction size, including}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00129}00129     \textcolor{comment}{// i-\/node, indirect block, allocation blocks,}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00130}00130     \textcolor{comment}{// and 2 blocks of slop for non-\/aligned writes.}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00131}00131     \textcolor{comment}{// this really belongs lower down, since writei()}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00132}00132     \textcolor{comment}{// might be writing a device like the console.}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00133}00133     \textcolor{keywordtype}{int} max = ((\mbox{\hyperlink{param_8h_a31cde324007b4e52bbba7079ec5e5f45}{MAXOPBLOCKS}}-\/1-\/1-\/2) / 2) * 512;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00134}00134     \textcolor{keywordtype}{int} i = 0;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00135}00135     \textcolor{keywordflow}{while}(i < n)\{}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00136}00136       \textcolor{keywordtype}{int} n1 = n -\/ i;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00137}00137       \textcolor{keywordflow}{if}(n1 > max)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00138}00138         n1 = max;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00139}00139 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00140}00140       \mbox{\hyperlink{defs_8h_a603ca98212e00d2ffdba7827ef0f1003}{begin\_op}}();}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00141}00141       \mbox{\hyperlink{defs_8h_a29a4d743d41fe659f74b0a57fdc25012}{ilock}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00142}00142       \textcolor{keywordflow}{if} ((\mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}} = \mbox{\hyperlink{defs_8h_a515876d4653cefef4732806ef7f2833f}{writei}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}}, addr + i, f-\/>\mbox{\hyperlink{structfile_a94a911be6cc1b1326728392d8b40150d}{off}}, n1)) > 0)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00143}00143         f-\/>\mbox{\hyperlink{structfile_a94a911be6cc1b1326728392d8b40150d}{off}} += \mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00144}00144       \mbox{\hyperlink{defs_8h_af301c10ad8ced77a5dfb2de3a64c666c}{iunlock}}(f-\/>\mbox{\hyperlink{structfile_a4fd095f927715574dc2a4f243690e508}{ip}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00145}00145       \mbox{\hyperlink{defs_8h_a2504e37a109f9bae5ca11fe89e4e8fa1}{end\_op}}();}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00146}00146 }
\DoxyCodeLine{\Hypertarget{file_8c_source_l00147}00147       \textcolor{keywordflow}{if}(\mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}} < 0)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00148}00148         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00149}00149       \textcolor{keywordflow}{if}(\mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}} != n1)}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00150}00150         \mbox{\hyperlink{console_8c_a95c0aca5d6d7487933984f08b189917a}{panic}}(\textcolor{stringliteral}{"{}short filewrite"{}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00151}00151       i += \mbox{\hyperlink{console_8c_af10fa12dd785c91e29528fbdc50cf9af}{r}};}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00152}00152     \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00153}00153     \textcolor{keywordflow}{return} i == n ? n : -\/1;}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00154}00154   \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00155}00155   \mbox{\hyperlink{console_8c_a95c0aca5d6d7487933984f08b189917a}{panic}}(\textcolor{stringliteral}{"{}filewrite"{}});}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00156}00156 \}}
\DoxyCodeLine{\Hypertarget{file_8c_source_l00157}00157 }

\end{DoxyCode}
