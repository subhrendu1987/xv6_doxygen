\hypertarget{mkfs_8c_source}{}\doxysection{mkfs.\+c}
\mbox{\hyperlink{mkfs_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00001}00001 \textcolor{preprocessor}{\#include <stdio.h>}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00002}00002 \textcolor{preprocessor}{\#include <unistd.h>}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00003}00003 \textcolor{preprocessor}{\#include <stdlib.h>}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00004}00004 \textcolor{preprocessor}{\#include <string.h>}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00005}00005 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{fcntl_8h}{fcntl.h}}>}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00006}00006 \textcolor{preprocessor}{\#include <assert.h>}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00007}00007 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00008}\mbox{\hyperlink{mkfs_8c_a149da0702b060478da4d59ffe807adac}{00008}} \textcolor{preprocessor}{\#define stat xv6\_stat  }\textcolor{comment}{// avoid clash with host struct stat}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00009}00009 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{types_8h}{types.h}}"{}}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00010}00010 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{fs_8h}{fs.h}}"{}}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00011}00011 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{stat_8h}{stat.h}}"{}}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00012}00012 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{param_8h}{param.h}}"{}}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00013}00013 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00014}00014 \textcolor{preprocessor}{\#ifndef static\_assert}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00015}\mbox{\hyperlink{mkfs_8c_abce67139ad0bc979ef080a694e60fb36}{00015}} \textcolor{preprocessor}{\#define static\_assert(a, b) do \{ switch (0) case 0: case (a): ; \} while (0)}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00016}00016 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00017}00017 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00018}\mbox{\hyperlink{mkfs_8c_ad285a4c453432da6be26e87a581ee35c}{00018}} \textcolor{preprocessor}{\#define NINODES 200}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00019}00019 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00020}00020 \textcolor{comment}{// Disk layout:}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00021}00021 \textcolor{comment}{// [ boot block | sb block | log | inode blocks | free bit map | data blocks ]}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00022}00022 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00023}\mbox{\hyperlink{mkfs_8c_ab3610080ec9ad31beae2488dffd98026}{00023}} \textcolor{keywordtype}{int} \mbox{\hyperlink{mkfs_8c_ab3610080ec9ad31beae2488dffd98026}{nbitmap}} = \mbox{\hyperlink{param_8h_a486f47992f736854db2444b01afd9991}{FSSIZE}}/(\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}*8) + 1;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00024}\mbox{\hyperlink{mkfs_8c_a86bf1487f875e3a82dbb4f7c0cde878c}{00024}} \textcolor{keywordtype}{int} \mbox{\hyperlink{mkfs_8c_a86bf1487f875e3a82dbb4f7c0cde878c}{ninodeblocks}} = \mbox{\hyperlink{mkfs_8c_ad285a4c453432da6be26e87a581ee35c}{NINODES}} / \mbox{\hyperlink{fs_8h_aadb6c866a6d0a173f5f0a6ed9c7e0228}{IPB}} + 1;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00025}\mbox{\hyperlink{mkfs_8c_aa86ff3fab07bd3139fcd159de0ffce90}{00025}} \textcolor{keywordtype}{int} \mbox{\hyperlink{mkfs_8c_aa86ff3fab07bd3139fcd159de0ffce90}{nlog}} = \mbox{\hyperlink{param_8h_acc7694167c7840a913939a1b90808b4c}{LOGSIZE}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00026}\mbox{\hyperlink{mkfs_8c_a6bb66ce69ae378551f55d86c515ae02c}{00026}} \textcolor{keywordtype}{int} \mbox{\hyperlink{mkfs_8c_a6bb66ce69ae378551f55d86c515ae02c}{nmeta}};    \textcolor{comment}{// Number of meta blocks (boot, sb, nlog, inode, bitmap)}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00027}\mbox{\hyperlink{mkfs_8c_a076c8e8b7f7acccc46cd356bd8776b26}{00027}} \textcolor{keywordtype}{int} \mbox{\hyperlink{mkfs_8c_a076c8e8b7f7acccc46cd356bd8776b26}{nblocks}};  \textcolor{comment}{// Number of data blocks}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00028}00028 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00029}\mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{00029}} \textcolor{keywordtype}{int} \mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{fsfd}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00030}\mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{00030}} \textcolor{keyword}{struct }\mbox{\hyperlink{structsuperblock}{superblock}} \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00031}\mbox{\hyperlink{mkfs_8c_aef2d52736d40de37197333ecdeb14a60}{00031}} \textcolor{keywordtype}{char} \mbox{\hyperlink{mkfs_8c_aef2d52736d40de37197333ecdeb14a60}{zeroes}}[\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00032}\mbox{\hyperlink{mkfs_8c_acee9059b25c8d81ef2b9cfedded17d48}{00032}} \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} \mbox{\hyperlink{mkfs_8c_acee9059b25c8d81ef2b9cfedded17d48}{freeinode}} = 1;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00033}\mbox{\hyperlink{mkfs_8c_a8d3a0b59d5f6e59c8b7c0bbdab41ab15}{00033}} \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} \mbox{\hyperlink{mkfs_8c_a8d3a0b59d5f6e59c8b7c0bbdab41ab15}{freeblock}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00034}00034 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00035}00035 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00036}00036 \textcolor{keywordtype}{void} \mbox{\hyperlink{mkfs_8c_a327cdfc7a74165d8922ec6c8ba256906}{balloc}}(\textcolor{keywordtype}{int});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00037}00037 \textcolor{keywordtype}{void} \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}}, \textcolor{keywordtype}{void}*);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00038}00038 \textcolor{keywordtype}{void} \mbox{\hyperlink{mkfs_8c_a2540c48cea7dc865909cfb3f8450a887}{winode}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}}, \textcolor{keyword}{struct} \mbox{\hyperlink{structdinode}{dinode}}*);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00039}00039 \textcolor{keywordtype}{void} \mbox{\hyperlink{mkfs_8c_a3b6cb1258a963010211a8e5ddf99defe}{rinode}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} inum, \textcolor{keyword}{struct} \mbox{\hyperlink{structdinode}{dinode}} *ip);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00040}00040 \textcolor{keywordtype}{void} \mbox{\hyperlink{mkfs_8c_a22ea835ad23cd716a962f30e4882ee80}{rsect}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} sec, \textcolor{keywordtype}{void} *\mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00041}00041 \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} \mbox{\hyperlink{mkfs_8c_a341af7faeda3d6fcb57a5a9fe3a0104a}{ialloc}}(\mbox{\hyperlink{types_8h_ab95f123a6c9bcfee6a343170ef8c5f69}{ushort}} type);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00042}00042 \textcolor{keywordtype}{void} \mbox{\hyperlink{mkfs_8c_a268b61616f575ff072f5bb34c83e02e9}{iappend}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} inum, \textcolor{keywordtype}{void} *p, \textcolor{keywordtype}{int} n);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00043}00043 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00044}00044 \textcolor{comment}{// convert to intel byte order}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00045}00045 \mbox{\hyperlink{types_8h_ab95f123a6c9bcfee6a343170ef8c5f69}{ushort}}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00046}\mbox{\hyperlink{mkfs_8c_ac6dbbb3aaeee7114cf795be284be08ce}{00046}} \mbox{\hyperlink{mkfs_8c_ac6dbbb3aaeee7114cf795be284be08ce}{xshort}}(\mbox{\hyperlink{types_8h_ab95f123a6c9bcfee6a343170ef8c5f69}{ushort}} x)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00047}00047 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00048}00048   \mbox{\hyperlink{types_8h_ab95f123a6c9bcfee6a343170ef8c5f69}{ushort}} y;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00049}00049   \mbox{\hyperlink{types_8h_a65f85814a8290f9797005d3b28e7e5fc}{uchar}} *a = (\mbox{\hyperlink{types_8h_a65f85814a8290f9797005d3b28e7e5fc}{uchar}}*)\&y;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00050}00050   a[0] = x;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00051}00051   a[1] = x >> 8;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00052}00052   \textcolor{keywordflow}{return} y;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00053}00053 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00054}00054 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00055}00055 \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00056}\mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{00056}} \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} x)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00057}00057 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00058}00058   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} y;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00059}00059   \mbox{\hyperlink{types_8h_a65f85814a8290f9797005d3b28e7e5fc}{uchar}} *a = (\mbox{\hyperlink{types_8h_a65f85814a8290f9797005d3b28e7e5fc}{uchar}}*)\&y;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00060}00060   a[0] = x;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00061}00061   a[1] = x >> 8;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00062}00062   a[2] = x >> 16;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00063}00063   a[3] = x >> 24;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00064}00064   \textcolor{keywordflow}{return} y;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00065}00065 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00066}00066 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00067}00067 \textcolor{keywordtype}{int}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00068}\mbox{\hyperlink{mkfs_8c_a0ddf1224851353fc92bfbff6f499fa97}{00068}} \mbox{\hyperlink{forktest_8c_a840291bc02cba5474a4cb46a9b9566fe}{main}}(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[])}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00069}00069 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00070}00070   \textcolor{keywordtype}{int} i, cc, fd;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00071}00071   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} rootino, inum, off;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00072}00072   \textcolor{keyword}{struct }\mbox{\hyperlink{structdirent}{dirent}} de;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00073}00073   \textcolor{keywordtype}{char} \mbox{\hyperlink{structbuf}{buf}}[\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00074}00074   \textcolor{keyword}{struct }\mbox{\hyperlink{structdinode}{dinode}} din;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00075}00075 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00076}00076 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00077}00077   \textcolor{keyword}{static\_assert}(\textcolor{keyword}{sizeof}(int) == 4, \textcolor{stringliteral}{"{}Integers must be 4 bytes!"{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00078}00078 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00079}00079   \textcolor{keywordflow}{if}(argc < 2)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00080}00080     fprintf(stderr, \textcolor{stringliteral}{"{}Usage: mkfs fs.img files...\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00081}00081     \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00082}00082   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00083}00083 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00084}00084   assert((\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}} \% \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \mbox{\hyperlink{structdinode}{dinode}})) == 0);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00085}00085   assert((\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}} \% \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \mbox{\hyperlink{structdirent}{dirent}})) == 0);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00086}00086 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00087}00087   \mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{fsfd}} = \mbox{\hyperlink{user_8h_a2c4414339f388561554c2deab11a1a07}{open}}(\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[1], \mbox{\hyperlink{fcntl_8h_abb0586253488ee61072b73557eeb873b}{O\_RDWR}}|O\_CREAT|O\_TRUNC, 0666);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00088}00088   \textcolor{keywordflow}{if}(\mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{fsfd}} < 0)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00089}00089     perror(\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[1]);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00090}00090     \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00091}00091   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00092}00092 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00093}00093   \textcolor{comment}{// 1 fs block = 1 disk sector}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00094}00094   \mbox{\hyperlink{mkfs_8c_a6bb66ce69ae378551f55d86c515ae02c}{nmeta}} = 2 + \mbox{\hyperlink{mkfs_8c_aa86ff3fab07bd3139fcd159de0ffce90}{nlog}} + \mbox{\hyperlink{mkfs_8c_a86bf1487f875e3a82dbb4f7c0cde878c}{ninodeblocks}} + \mbox{\hyperlink{mkfs_8c_ab3610080ec9ad31beae2488dffd98026}{nbitmap}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00095}00095   \mbox{\hyperlink{mkfs_8c_a076c8e8b7f7acccc46cd356bd8776b26}{nblocks}} = \mbox{\hyperlink{param_8h_a486f47992f736854db2444b01afd9991}{FSSIZE}} -\/ \mbox{\hyperlink{mkfs_8c_a6bb66ce69ae378551f55d86c515ae02c}{nmeta}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00096}00096 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00097}00097   \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_a7c6e4d6da139ecee74eb7816d5d44fa6}{size}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{param_8h_a486f47992f736854db2444b01afd9991}{FSSIZE}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00098}00098   \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_a2a27a7cfb54689f0e1dcd1788d049218}{nblocks}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{mkfs_8c_a076c8e8b7f7acccc46cd356bd8776b26}{nblocks}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00099}00099   \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_a355d2a1ebdc51f80820c23e69363cf42}{ninodes}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{mkfs_8c_ad285a4c453432da6be26e87a581ee35c}{NINODES}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00100}00100   \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_aea92ae872785fd4fb39b903d9157aac5}{nlog}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{mkfs_8c_aa86ff3fab07bd3139fcd159de0ffce90}{nlog}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00101}00101   \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_a460268b28aced19797e8d7b84aa60ebf}{logstart}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(2);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00102}00102   \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_adde361528f3905445974301b424611c1}{inodestart}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(2+\mbox{\hyperlink{mkfs_8c_aa86ff3fab07bd3139fcd159de0ffce90}{nlog}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00103}00103   \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_a3c815dda5be6bda609389e76434171cc}{bmapstart}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(2+\mbox{\hyperlink{mkfs_8c_aa86ff3fab07bd3139fcd159de0ffce90}{nlog}}+\mbox{\hyperlink{mkfs_8c_a86bf1487f875e3a82dbb4f7c0cde878c}{ninodeblocks}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00104}00104 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00105}00105   \mbox{\hyperlink{forktest_8c_a249680925885256274fa9f02dd51cec4}{printf}}(\textcolor{stringliteral}{"{}nmeta \%d (boot, super, log blocks \%u inode blocks \%u, bitmap blocks \%u) blocks \%d total \%d\(\backslash\)n"{}},}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00106}00106          \mbox{\hyperlink{mkfs_8c_a6bb66ce69ae378551f55d86c515ae02c}{nmeta}}, \mbox{\hyperlink{mkfs_8c_aa86ff3fab07bd3139fcd159de0ffce90}{nlog}}, \mbox{\hyperlink{mkfs_8c_a86bf1487f875e3a82dbb4f7c0cde878c}{ninodeblocks}}, \mbox{\hyperlink{mkfs_8c_ab3610080ec9ad31beae2488dffd98026}{nbitmap}}, \mbox{\hyperlink{mkfs_8c_a076c8e8b7f7acccc46cd356bd8776b26}{nblocks}}, \mbox{\hyperlink{param_8h_a486f47992f736854db2444b01afd9991}{FSSIZE}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00107}00107 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00108}00108   \mbox{\hyperlink{mkfs_8c_a8d3a0b59d5f6e59c8b7c0bbdab41ab15}{freeblock}} = \mbox{\hyperlink{mkfs_8c_a6bb66ce69ae378551f55d86c515ae02c}{nmeta}};     \textcolor{comment}{// the first free block that we can allocate}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00109}00109 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00110}00110   \textcolor{keywordflow}{for}(i = 0; i < \mbox{\hyperlink{param_8h_a486f47992f736854db2444b01afd9991}{FSSIZE}}; i++)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00111}00111     \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(i, \mbox{\hyperlink{mkfs_8c_aef2d52736d40de37197333ecdeb14a60}{zeroes}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00112}00112 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00113}00113   \mbox{\hyperlink{defs_8h_a0098886a849eef10803e9f35ceec61b9}{memset}}(\mbox{\hyperlink{structbuf}{buf}}, 0, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structbuf}{buf}}));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00114}00114   \mbox{\hyperlink{defs_8h_ac152fff34fe03e497d35b1d4c47f1445}{memmove}}(\mbox{\hyperlink{structbuf}{buf}}, \&\mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00115}00115   \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(1, \mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00116}00116 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00117}00117   rootino = \mbox{\hyperlink{mkfs_8c_a341af7faeda3d6fcb57a5a9fe3a0104a}{ialloc}}(\mbox{\hyperlink{stat_8h_a91136bcd71a9f499304f5d7e7e9d6376}{T\_DIR}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00118}00118   assert(rootino == \mbox{\hyperlink{fs_8h_a22c8ea96d09283ed6496347806cc72a0}{ROOTINO}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00119}00119 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00120}00120   bzero(\&de, \textcolor{keyword}{sizeof}(de));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00121}00121   de.\mbox{\hyperlink{structdirent_a68698c303a46d2a34232a2226629ac79}{inum}} = \mbox{\hyperlink{mkfs_8c_ac6dbbb3aaeee7114cf795be284be08ce}{xshort}}(rootino);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00122}00122   \mbox{\hyperlink{ulib_8c_a8047435e7597349a349589b1e264d1d8}{strcpy}}(de.\mbox{\hyperlink{structdirent_a4e08a84dbac9b9f6a3e006151855d14d}{name}}, \textcolor{stringliteral}{"{}."{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00123}00123   \mbox{\hyperlink{mkfs_8c_a268b61616f575ff072f5bb34c83e02e9}{iappend}}(rootino, \&de, \textcolor{keyword}{sizeof}(de));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00124}00124 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00125}00125   bzero(\&de, \textcolor{keyword}{sizeof}(de));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00126}00126   de.\mbox{\hyperlink{structdirent_a68698c303a46d2a34232a2226629ac79}{inum}} = \mbox{\hyperlink{mkfs_8c_ac6dbbb3aaeee7114cf795be284be08ce}{xshort}}(rootino);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00127}00127   \mbox{\hyperlink{ulib_8c_a8047435e7597349a349589b1e264d1d8}{strcpy}}(de.\mbox{\hyperlink{structdirent_a4e08a84dbac9b9f6a3e006151855d14d}{name}}, \textcolor{stringliteral}{"{}.."{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00128}00128   \mbox{\hyperlink{mkfs_8c_a268b61616f575ff072f5bb34c83e02e9}{iappend}}(rootino, \&de, \textcolor{keyword}{sizeof}(de));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00129}00129 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00130}00130   \textcolor{keywordflow}{for}(i = 2; i < argc; i++)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00131}00131     assert(index(\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[i], \textcolor{charliteral}{'/'}) == 0);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00132}00132 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00133}00133     \textcolor{keywordflow}{if}((fd = \mbox{\hyperlink{user_8h_a2c4414339f388561554c2deab11a1a07}{open}}(\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[i], 0)) < 0)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00134}00134       perror(\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[i]);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00135}00135       \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00136}00136     \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00137}00137 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00138}00138     \textcolor{comment}{// Skip leading \_ in name when writing to file system.}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00139}00139     \textcolor{comment}{// The binaries are named \_rm, \_cat, etc. to keep the}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00140}00140     \textcolor{comment}{// build operating system from trying to execute them}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00141}00141     \textcolor{comment}{// in place of system binaries like rm and cat.}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00142}00142     \textcolor{keywordflow}{if}(\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[i][0] == \textcolor{charliteral}{'\_'})}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00143}00143       ++\mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[i];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00144}00144 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00145}00145     inum = \mbox{\hyperlink{mkfs_8c_a341af7faeda3d6fcb57a5a9fe3a0104a}{ialloc}}(\mbox{\hyperlink{stat_8h_a0a8afbed81f5fb3930e9d153fbd51737}{T\_FILE}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00146}00146 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00147}00147     bzero(\&de, \textcolor{keyword}{sizeof}(de));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00148}00148     de.\mbox{\hyperlink{structdirent_a68698c303a46d2a34232a2226629ac79}{inum}} = \mbox{\hyperlink{mkfs_8c_ac6dbbb3aaeee7114cf795be284be08ce}{xshort}}(inum);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00149}00149     \mbox{\hyperlink{defs_8h_a66107cd2364627727a36cef6c773b39c}{strncpy}}(de.\mbox{\hyperlink{structdirent_a4e08a84dbac9b9f6a3e006151855d14d}{name}}, \mbox{\hyperlink{init_8c_abd1a2cf54950f450187ef24c1cdcac0c}{argv}}[i], \mbox{\hyperlink{fs_8h_a48246fb9e5cb7f6a71ebc9ebc2f06562}{DIRSIZ}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00150}00150     \mbox{\hyperlink{mkfs_8c_a268b61616f575ff072f5bb34c83e02e9}{iappend}}(rootino, \&de, \textcolor{keyword}{sizeof}(de));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00151}00151 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00152}00152     \textcolor{keywordflow}{while}((cc = \mbox{\hyperlink{user_8h_a2d73522d6354b8a141ecfaa9585a0c77}{read}}(fd, \mbox{\hyperlink{structbuf}{buf}}, \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structbuf}{buf}}))) > 0)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00153}00153       \mbox{\hyperlink{mkfs_8c_a268b61616f575ff072f5bb34c83e02e9}{iappend}}(inum, \mbox{\hyperlink{structbuf}{buf}}, cc);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00154}00154 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00155}00155     \mbox{\hyperlink{user_8h_ae152484c890a24e4d9b4980e7b965be0}{close}}(fd);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00156}00156   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00157}00157 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00158}00158   \textcolor{comment}{// fix size of root inode dir}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00159}00159   \mbox{\hyperlink{mkfs_8c_a3b6cb1258a963010211a8e5ddf99defe}{rinode}}(rootino, \&din);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00160}00160   off = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(din.\mbox{\hyperlink{structdinode_a990ad8ddf5f8c051fbbe95cf550d2164}{size}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00161}00161   off = ((off/\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}) + 1) * \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00162}00162   din.\mbox{\hyperlink{structdinode_a990ad8ddf5f8c051fbbe95cf550d2164}{size}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(off);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00163}00163   \mbox{\hyperlink{mkfs_8c_a2540c48cea7dc865909cfb3f8450a887}{winode}}(rootino, \&din);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00164}00164 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00165}00165   \mbox{\hyperlink{mkfs_8c_a327cdfc7a74165d8922ec6c8ba256906}{balloc}}(\mbox{\hyperlink{mkfs_8c_a8d3a0b59d5f6e59c8b7c0bbdab41ab15}{freeblock}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00166}00166 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00167}00167   \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(0);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00168}00168 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00169}00169 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00170}00170 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00171}\mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{00171}} \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} sec, \textcolor{keywordtype}{void} *\mbox{\hyperlink{structbuf}{buf}})}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00172}00172 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00173}00173   \textcolor{keywordflow}{if}(lseek(\mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{fsfd}}, sec * \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}, 0) != sec * \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}})\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00174}00174     perror(\textcolor{stringliteral}{"{}lseek"{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00175}00175     \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00176}00176   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00177}00177   \textcolor{keywordflow}{if}(\mbox{\hyperlink{user_8h_ae57e95d717eb7386cd8b935a0c136abe}{write}}(\mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{fsfd}}, \mbox{\hyperlink{structbuf}{buf}}, \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}) != \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}})\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00178}00178     perror(\textcolor{stringliteral}{"{}write"{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00179}00179     \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00180}00180   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00181}00181 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00182}00182 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00183}00183 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00184}\mbox{\hyperlink{mkfs_8c_a2540c48cea7dc865909cfb3f8450a887}{00184}} \mbox{\hyperlink{mkfs_8c_a2540c48cea7dc865909cfb3f8450a887}{winode}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} inum, \textcolor{keyword}{struct} \mbox{\hyperlink{structdinode}{dinode}} *ip)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00185}00185 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00186}00186   \textcolor{keywordtype}{char} \mbox{\hyperlink{structbuf}{buf}}[\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00187}00187   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} bn;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00188}00188   \textcolor{keyword}{struct }\mbox{\hyperlink{structdinode}{dinode}} *dip;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00189}00189 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00190}00190   bn = \mbox{\hyperlink{fs_8h_ac9a5b990015f0f86e5d4c6b21d38ffa0}{IBLOCK}}(inum, \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00191}00191   \mbox{\hyperlink{mkfs_8c_a22ea835ad23cd716a962f30e4882ee80}{rsect}}(bn, \mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00192}00192   dip = ((\textcolor{keyword}{struct }\mbox{\hyperlink{structdinode}{dinode}}*)\mbox{\hyperlink{structbuf}{buf}}) + (inum \% \mbox{\hyperlink{fs_8h_aadb6c866a6d0a173f5f0a6ed9c7e0228}{IPB}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00193}00193   *dip = *ip;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00194}00194   \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(bn, \mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00195}00195 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00196}00196 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00197}00197 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00198}\mbox{\hyperlink{mkfs_8c_a3b6cb1258a963010211a8e5ddf99defe}{00198}} \mbox{\hyperlink{mkfs_8c_a3b6cb1258a963010211a8e5ddf99defe}{rinode}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} inum, \textcolor{keyword}{struct} \mbox{\hyperlink{structdinode}{dinode}} *ip)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00199}00199 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00200}00200   \textcolor{keywordtype}{char} \mbox{\hyperlink{structbuf}{buf}}[\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00201}00201   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} bn;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00202}00202   \textcolor{keyword}{struct }\mbox{\hyperlink{structdinode}{dinode}} *dip;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00203}00203 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00204}00204   bn = \mbox{\hyperlink{fs_8h_ac9a5b990015f0f86e5d4c6b21d38ffa0}{IBLOCK}}(inum, \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00205}00205   \mbox{\hyperlink{mkfs_8c_a22ea835ad23cd716a962f30e4882ee80}{rsect}}(bn, \mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00206}00206   dip = ((\textcolor{keyword}{struct }\mbox{\hyperlink{structdinode}{dinode}}*)\mbox{\hyperlink{structbuf}{buf}}) + (inum \% \mbox{\hyperlink{fs_8h_aadb6c866a6d0a173f5f0a6ed9c7e0228}{IPB}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00207}00207   *ip = *dip;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00208}00208 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00209}00209 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00210}00210 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00211}\mbox{\hyperlink{mkfs_8c_a22ea835ad23cd716a962f30e4882ee80}{00211}} \mbox{\hyperlink{mkfs_8c_a22ea835ad23cd716a962f30e4882ee80}{rsect}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} sec, \textcolor{keywordtype}{void} *\mbox{\hyperlink{structbuf}{buf}})}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00212}00212 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00213}00213   \textcolor{keywordflow}{if}(lseek(\mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{fsfd}}, sec * \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}, 0) != sec * \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}})\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00214}00214     perror(\textcolor{stringliteral}{"{}lseek"{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00215}00215     \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00216}00216   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00217}00217   \textcolor{keywordflow}{if}(\mbox{\hyperlink{user_8h_a2d73522d6354b8a141ecfaa9585a0c77}{read}}(\mbox{\hyperlink{mkfs_8c_a44f12de41bc5a5ada9e5fff19c18201c}{fsfd}}, \mbox{\hyperlink{structbuf}{buf}}, \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}) != \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}})\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00218}00218     perror(\textcolor{stringliteral}{"{}read"{}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00219}00219     \mbox{\hyperlink{defs_8h_aaf98ef7cdde3a0dfb2e49919de3298b1}{exit}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00220}00220   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00221}00221 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00222}00222 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00223}00223 \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00224}\mbox{\hyperlink{mkfs_8c_a341af7faeda3d6fcb57a5a9fe3a0104a}{00224}} \mbox{\hyperlink{mkfs_8c_a341af7faeda3d6fcb57a5a9fe3a0104a}{ialloc}}(\mbox{\hyperlink{types_8h_ab95f123a6c9bcfee6a343170ef8c5f69}{ushort}} \mbox{\hyperlink{structdinode_abf6b2a8476a803284f1c927fb3b82259}{type}})}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00225}00225 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00226}00226   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} inum = \mbox{\hyperlink{mkfs_8c_acee9059b25c8d81ef2b9cfedded17d48}{freeinode}}++;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00227}00227   \textcolor{keyword}{struct }\mbox{\hyperlink{structdinode}{dinode}} din;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00228}00228 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00229}00229   bzero(\&din, \textcolor{keyword}{sizeof}(din));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00230}00230   din.\mbox{\hyperlink{structdinode_abf6b2a8476a803284f1c927fb3b82259}{type}} = \mbox{\hyperlink{mkfs_8c_ac6dbbb3aaeee7114cf795be284be08ce}{xshort}}(\mbox{\hyperlink{structdinode_abf6b2a8476a803284f1c927fb3b82259}{type}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00231}00231   din.\mbox{\hyperlink{structdinode_a105562253b461c11413c9a229ef15358}{nlink}} = \mbox{\hyperlink{mkfs_8c_ac6dbbb3aaeee7114cf795be284be08ce}{xshort}}(1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00232}00232   din.\mbox{\hyperlink{structdinode_a990ad8ddf5f8c051fbbe95cf550d2164}{size}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(0);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00233}00233   \mbox{\hyperlink{mkfs_8c_a2540c48cea7dc865909cfb3f8450a887}{winode}}(inum, \&din);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00234}00234   \textcolor{keywordflow}{return} inum;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00235}00235 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00236}00236 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00237}00237 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00238}\mbox{\hyperlink{mkfs_8c_a327cdfc7a74165d8922ec6c8ba256906}{00238}} \mbox{\hyperlink{mkfs_8c_a327cdfc7a74165d8922ec6c8ba256906}{balloc}}(\textcolor{keywordtype}{int} used)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00239}00239 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00240}00240   \mbox{\hyperlink{types_8h_a65f85814a8290f9797005d3b28e7e5fc}{uchar}} \mbox{\hyperlink{structbuf}{buf}}[\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00241}00241   \textcolor{keywordtype}{int} i;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00242}00242 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00243}00243   \mbox{\hyperlink{forktest_8c_a249680925885256274fa9f02dd51cec4}{printf}}(\textcolor{stringliteral}{"{}balloc: first \%d blocks have been allocated\(\backslash\)n"{}}, used);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00244}00244   assert(used < \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}*8);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00245}00245   bzero(\mbox{\hyperlink{structbuf}{buf}}, \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00246}00246   \textcolor{keywordflow}{for}(i = 0; i < used; i++)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00247}00247     \mbox{\hyperlink{structbuf}{buf}}[i/8] = \mbox{\hyperlink{structbuf}{buf}}[i/8] | (0x1 << (i\%8));}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00248}00248   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00249}00249   \mbox{\hyperlink{forktest_8c_a249680925885256274fa9f02dd51cec4}{printf}}(\textcolor{stringliteral}{"{}balloc: write bitmap block at sector \%d\(\backslash\)n"{}}, \mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_a3c815dda5be6bda609389e76434171cc}{bmapstart}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00250}00250   \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(\mbox{\hyperlink{mkfs_8c_a0248d0bac625de5a1415f2f8c91f3343}{sb}}.\mbox{\hyperlink{structsuperblock_a3c815dda5be6bda609389e76434171cc}{bmapstart}}, \mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00251}00251 \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00252}00252 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00253}\mbox{\hyperlink{mkfs_8c_ac6afabdc09a49a433ee19d8a9486056d}{00253}} \textcolor{preprocessor}{\#define min(a, b) ((a) < (b) ? (a) : (b))}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00254}00254 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00255}00255 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00256}\mbox{\hyperlink{mkfs_8c_a268b61616f575ff072f5bb34c83e02e9}{00256}} \mbox{\hyperlink{mkfs_8c_a268b61616f575ff072f5bb34c83e02e9}{iappend}}(\mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} inum, \textcolor{keywordtype}{void} *xp, \textcolor{keywordtype}{int} n)}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00257}00257 \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00258}00258   \textcolor{keywordtype}{char} *p = (\textcolor{keywordtype}{char}*)xp;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00259}00259   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} fbn, off, n1;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00260}00260   \textcolor{keyword}{struct }\mbox{\hyperlink{structdinode}{dinode}} din;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00261}00261   \textcolor{keywordtype}{char} \mbox{\hyperlink{structbuf}{buf}}[\mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00262}00262   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} indirect[\mbox{\hyperlink{fs_8h_a6d24f098ea2928d61ff80b123d761715}{NINDIRECT}}];}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00263}00263   \mbox{\hyperlink{types_8h_a91ad9478d81a7aaf2593e8d9c3d06a14}{uint}} x;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00264}00264 }
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00265}00265   \mbox{\hyperlink{mkfs_8c_a3b6cb1258a963010211a8e5ddf99defe}{rinode}}(inum, \&din);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00266}00266   off = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(din.\mbox{\hyperlink{structdinode_a990ad8ddf5f8c051fbbe95cf550d2164}{size}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00267}00267   \textcolor{comment}{// printf("{}append inum \%d at off \%d sz \%d\(\backslash\)n"{}, inum, off, n);}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00268}00268   \textcolor{keywordflow}{while}(n > 0)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00269}00269     fbn = off / \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}};}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00270}00270     assert(fbn < \mbox{\hyperlink{fs_8h_a714b2485a6dd312e37226e1f833728a9}{MAXFILE}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00271}00271     \textcolor{keywordflow}{if}(fbn < \mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}})\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00272}00272       \textcolor{keywordflow}{if}(\mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(din.\mbox{\hyperlink{structdinode_a705729b3a39c10c0ba6927fc5e4e0563}{addrs}}[fbn]) == 0)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00273}00273         din.\mbox{\hyperlink{structdinode_a705729b3a39c10c0ba6927fc5e4e0563}{addrs}}[fbn] = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{mkfs_8c_a8d3a0b59d5f6e59c8b7c0bbdab41ab15}{freeblock}}++);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00274}00274       \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00275}00275       x = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(din.\mbox{\hyperlink{structdinode_a705729b3a39c10c0ba6927fc5e4e0563}{addrs}}[fbn]);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00276}00276     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00277}00277       \textcolor{keywordflow}{if}(\mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(din.\mbox{\hyperlink{structdinode_a705729b3a39c10c0ba6927fc5e4e0563}{addrs}}[\mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}}]) == 0)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00278}00278         din.\mbox{\hyperlink{structdinode_a705729b3a39c10c0ba6927fc5e4e0563}{addrs}}[\mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}}] = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{mkfs_8c_a8d3a0b59d5f6e59c8b7c0bbdab41ab15}{freeblock}}++);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00279}00279       \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00280}00280       \mbox{\hyperlink{mkfs_8c_a22ea835ad23cd716a962f30e4882ee80}{rsect}}(\mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(din.\mbox{\hyperlink{structdinode_a705729b3a39c10c0ba6927fc5e4e0563}{addrs}}[\mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}}]), (\textcolor{keywordtype}{char}*)indirect);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00281}00281       \textcolor{keywordflow}{if}(indirect[fbn -\/ \mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}}] == 0)\{}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00282}00282         indirect[fbn -\/ \mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}}] = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(\mbox{\hyperlink{mkfs_8c_a8d3a0b59d5f6e59c8b7c0bbdab41ab15}{freeblock}}++);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00283}00283         \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(\mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(din.\mbox{\hyperlink{structdinode_a705729b3a39c10c0ba6927fc5e4e0563}{addrs}}[\mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}}]), (\textcolor{keywordtype}{char}*)indirect);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00284}00284       \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00285}00285       x = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(indirect[fbn-\/\mbox{\hyperlink{fs_8h_acd38e9532d4b3623f844b93c012a8e06}{NDIRECT}}]);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00286}00286     \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00287}00287     n1 = \mbox{\hyperlink{mkfs_8c_ac6afabdc09a49a433ee19d8a9486056d}{min}}(n, (fbn + 1) * \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}} -\/ off);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00288}00288     \mbox{\hyperlink{mkfs_8c_a22ea835ad23cd716a962f30e4882ee80}{rsect}}(x, \mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00289}00289     bcopy(p, \mbox{\hyperlink{structbuf}{buf}} + off -\/ (fbn * \mbox{\hyperlink{fs_8h_a403cf3149c084cea115b85c90721039a}{BSIZE}}), n1);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00290}00290     \mbox{\hyperlink{mkfs_8c_ac62d827d836d1807e4d6f365f32348bb}{wsect}}(x, \mbox{\hyperlink{structbuf}{buf}});}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00291}00291     n -\/= n1;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00292}00292     off += n1;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00293}00293     p += n1;}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00294}00294   \}}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00295}00295   din.\mbox{\hyperlink{structdinode_a990ad8ddf5f8c051fbbe95cf550d2164}{size}} = \mbox{\hyperlink{mkfs_8c_a0cb088f1b4dabee9a6056b88a8f813ef}{xint}}(off);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00296}00296   \mbox{\hyperlink{mkfs_8c_a2540c48cea7dc865909cfb3f8450a887}{winode}}(inum, \&din);}
\DoxyCodeLine{\Hypertarget{mkfs_8c_source_l00297}00297 \}}

\end{DoxyCode}
